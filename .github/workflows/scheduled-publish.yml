name: Publication planifiée

on:
  schedule:
    # Tous les jours à 6h du matin (heure de Paris = 5h UTC)
    - cron: '0 5 * * *'
  workflow_dispatch: # Permet de déclencher manuellement depuis GitHub

jobs:
  publish-drafts:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: main

      - name: Publier les contenus planifiés
        run: |
          TODAY=$(date -u +%Y-%m-%d)
          SCHEDULE="_drafts/schedule.json"
          PUBLISHED=false

          if [ ! -f "$SCHEDULE" ]; then
            echo "Pas de fichier schedule.json, rien à publier."
            exit 0
          fi

          # Lire chaque entrée du planning
          COUNT=$(jq length "$SCHEDULE")

          for i in $(seq 0 $(($COUNT - 1))); do
            FILE=$(jq -r ".[$i].file" "$SCHEDULE")
            DEST=$(jq -r ".[$i].destination" "$SCHEDULE")
            DATE=$(jq -r ".[$i].publish_date" "$SCHEDULE")
            DESC=$(jq -r ".[$i].description // empty" "$SCHEDULE")

            # Vérifier si la date de publication est aujourd'hui ou passée
            if [ "$DATE" \<= "$TODAY" ]; then
              DRAFT_PATH="_drafts/$FILE"

              if [ -f "$DRAFT_PATH" ]; then
                # Créer le dossier de destination si nécessaire
                mkdir -p "$(dirname "$DEST")"

                # Déplacer le fichier
                mv "$DRAFT_PATH" "$DEST"

                echo "Publié : $FILE -> $DEST (prévu le $DATE)"
                PUBLISHED=true
              else
                echo "Fichier introuvable : $DRAFT_PATH (ignoré)"
              fi
            else
              echo "Pas encore : $FILE prévu pour $DATE (aujourd'hui : $TODAY)"
            fi
          done

          if [ "$PUBLISHED" = true ]; then
            # Nettoyer le schedule.json : retirer les entrées publiées
            jq --arg today "$TODAY" '[.[] | select(.publish_date > $today)]' "$SCHEDULE" > tmp.json
            mv tmp.json "$SCHEDULE"

            # Commit et push
            git config user.name "github-actions[bot]"
            git config user.email "github-actions[bot]@users.noreply.github.com"
            git add -A
            git commit -m "Publication planifiée du $TODAY"
            git push
          else
            echo "Rien à publier aujourd'hui."
          fi
